<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="Hulk Dev Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Hulk Dev Blog Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="Hulk Dev Blog JSON Feed"><title data-rh="true">美图开源任务队列 - LMSTFY | Hulk Dev Blog</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://hulkdev.com/posts-meitu-opensource-task-queue"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="美图开源任务队列 - LMSTFY | Hulk Dev Blog"><meta data-rh="true" name="description" content="lmstfy(Let Me Schedule Task For You) 是美图架构基础服务团队在 2018 年初基于 Redis 实现的简单任务队列(Task Queue)服务，目前在美图多个线上产品使用接近两年的时间。主要提供以下特性:"><meta data-rh="true" property="og:description" content="lmstfy(Let Me Schedule Task For You) 是美图架构基础服务团队在 2018 年初基于 Redis 实现的简单任务队列(Task Queue)服务，目前在美图多个线上产品使用接近两年的时间。主要提供以下特性:"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2019-11-28T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="LMSTFY,Queue,Redis"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hulkdev.com/posts-meitu-opensource-task-queue"><link data-rh="true" rel="alternate" href="https://hulkdev.com/posts-meitu-opensource-task-queue" hreflang="en"><link data-rh="true" rel="alternate" href="https://hulkdev.com/posts-meitu-opensource-task-queue" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.4b072bfe.css">
<link rel="preload" href="/assets/js/runtime~main.36814b66.js" as="script">
<link rel="preload" href="/assets/js/main.e80ad31c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Enginerring Hulk Blog" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.svg" alt="Enginerring Hulk Blog" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Engineering Hulk Blog</b></a><a class="navbar__item navbar__link" href="/archive">Archive</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/git-hulk" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently dark mode)" aria-label="Switch between dark and light mode (currently dark mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_Pkmr"><kbd class="searchHint_iIMx">ctrl</kbd><kbd class="searchHint_iIMx">K</kbd></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts-writing-by-notes">卡片笔记写作法 - 读书笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/monitoring-go-apps-with-distributed-tracing-and-opentelemetry">Monitoring Go apps with Distributed Tracing and OpenTelemetry</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts-how-to-impl-bitmap-on-disk-kv">如何基于磁盘 KV 实现 Bitmap</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/intro-opensource-kvrocks">Kvrocks 一款开源的企业级磁盘KV存储服务</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/posts-holes-in-php-memcached">php-memcached 的一些坑</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">美图开源任务队列 - LMSTFY</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2019-11-28T00:00:00.000Z" itemprop="datePublished">November 28, 2019</time> · <!-- -->13 min read</div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>lmstfy(Let Me Schedule Task For You) 是美图架构基础服务团队在 2018 年初基于 Redis 实现的简单任务队列(Task Queue)服务，目前在美图多个线上产品使用接近两年的时间。主要提供以下特性:</p><ul><li>任务具备延时、自动重试、优先级以及过期等功能</li><li>通过 HTTP restful API 提供服务</li><li>具备横向扩展能力</li><li>丰富的业务和性能指标</li></ul><p>Github 项目地址: <a href="https://github.com/meitu/lmstfy" target="_blank" rel="noopener noreferrer">https://github.com/meitu/lmstfy</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="使用场景">使用场景<a class="hash-link" href="#使用场景" title="Direct link to heading">​</a></h2><p>任务队列跟消息队列在使用场景上最大的区别是： 任务之间是没有顺序约束而消息要求顺序(FIFO)，且可能会对任务的状态更新而消息一般只会消费不会更新。 类似 Kafka 利用消息 FIFO 和不需要更新(不需要对消息做索引)的特性来设计消息存储，将消息读写变成磁盘的顺序读写来实现比较好的性能。而任务队列需要能够任务状态进行更新则需要对每个消息进行索引，所以如果把两者放到一起实现则很难实在现功能和性能上兼得。</p><p>我们在以下几种场景会使用任务队列:</p><ol><li>定时任务，如每天早上 8 点开始推送消息，定期删除过期数据等</li><li>任务流，如自动创建 Redis 流程由资源创建，资源配置，DNS 修改等部分组成，使用任务队列可以简化整体的设计和重试流程</li><li>重试任务，典型场景如离线图片处理</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="目标与调研">目标与调研<a class="hash-link" href="#目标与调研" title="Direct link to heading">​</a></h2><p>在自研任务队列之前，我们基于以下几个要求作为约束调研了现有一些开源方案:</p><ul><li>任务支持延时/优先级任务和自动重试</li><li>高可用，服务不能有单点以及保证数据不丢失</li><li>可扩展，主要是容量和性能需要可扩展</li></ul><p>第一种方案是 Redis 作者开源的分布式内存队列 (disque)<!-- -->[https://github.com/antirez/disque]<!-- -->。disque 采用和 Redis Cluster 类似无中心设计，所有节点都可以写入并复制到其他节点。不管是从功能上、设计还是可靠性都是比较好的选择。我们在 2017 年也引入 disque 在部分业务使用过一段时间，后面遇到 bug 在内部修复后想反馈到社区，发现 Redis 作者决定不再维护这个项目(要把 disque 功能作为 redis module 来维护，应该是会伴随 Redis 6 发布)。最终我们也放弃了 disque 方案，将数据迁移到我们自研任务队列服务。</p><p>第二种方案是 2007 年就开源的 (beanstalkd)<!-- -->[https://github.com/beanstalkd/beanstalkd]<!-- -->，现在仍然还是在维护状态。beanstalkd 是类 memcached 协议全内存任务队列，断电或者重启时通过 WAL 文件来恢复数据。但 benstalkd 不支持复制功能，服务存在单点问题且数据可靠性也无法满足。当时也有考虑基于 beanstalkd 去做二次开发，但看完代码之后觉得需要改造的点不只是复制，还有类似内存控制等等，所以没有选择 beanstalkd 二次开发的方案。</p><p>也考虑过类似基于 kafka/rocketmq 等消息队列作为存储的方案，最后从存储设计模型和团队技术栈等原因决定选择基于 redis 作为存储来实现任务队列的功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="设计和实现">设计和实现<a class="hash-link" href="#设计和实现" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础概念">基础概念<a class="hash-link" href="#基础概念" title="Direct link to heading">​</a></h3><ul><li>namespace - 用来隔离业务，每个业务是独立的 namespace</li><li>queue - 队列名称，用区分同一业务不同消息类型</li><li>job - 业务定义的业务，主要包含以下几个属性:<ul><li>id: 任务 ID，全局唯一</li><li>delay: 任务延时下发时间， 单位是秒</li><li>tries: 任务最大重试次数，tries = N 表示任务会最多下发 N 次</li><li>ttl(time to live): 任务最长有效期，超过之后任务自动消失</li><li>ttr(time to run): 任务预期执行时间，超过 ttr 则认为任务消费失败，触发任务自动重试</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据存储">数据存储<a class="hash-link" href="#数据存储" title="Direct link to heading">​</a></h3><p>lmstfy 的 redis 存储由四部分组成:</p><ol><li>timer(sorted set) - 用来实现延迟任务的排序，再由后台线程定期将到期的任务写入到 Ready Queue 里面</li><li>ready queue (list) - 无延时或者已到期任务的队列</li><li>deadletter (list) - 消费失败(重试次数到达上限)的任务，可以手动重新放回队列</li><li>job pool(string) - 存储消息内容的池子</li></ol><p>支持延迟的任务队列本质上是两个数据结构的结合: FIFO 和 sorted set。sorted set 用来实现延时的部分，将任务按照到期时间戳升序存储，然后定期将到期的任务迁移至 FIFO(ready queue)。任务的具体内容只会存储一份在 job pool 里面，其他的像 ready queue，timer，deadletter 只是存储 job id，这样可以节省一些内存空间。</p><p>以下是整体设计:</p><p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/git-hulk/git-hulk.github.io/images/lmstfy-arch.png" alt="img" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="任务写入">任务写入<a class="hash-link" href="#任务写入" title="Direct link to heading">​</a></h3><p>任务在写入时会先产生一个 job id，目前 job id (16bytes) 包含写入时间戳、 随机数和延迟秒数， 然后写入 key 为 <code>j:{namespace}/{queue}/{ID}</code> 的任务到任务池 (pool) 里面。之后根据延时时间来决定这个 job id 应该到 ready queue 还是 timer 里面:</p><ul><li>delay = 0，表示不需要延时则直接写到 ready queue(list)</li><li>delay = n(n &gt; 0)，表示需要延时，将延时加上当前系统时间作为绝对时间戳写到 timer(sorted set)</li></ul><p>timer 的实现是利用 zset 根据绝对时间戳进行排序，再由旁路线程定期轮询将到期的任务通过 redis lua script 来将数据原子地转移到 ready queue 里面。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="任务消费">任务消费<a class="hash-link" href="#任务消费" title="Direct link to heading">​</a></h3><p>之前提到任务在消费失败之后预期能够重试，所以必须知道什么时候可认为任务消费失败？业务在消费时需要携带 ttr(time to run) 参数，用来表示业务预期任务最长执行时间，如果在 ttr 时间内没有收到业务主动回复 ACK 消息则会认为任务失败(类似 tcp 的重传 timer)。</p><p><img loading="lazy" src="https://cdn.jsdelivr.net/gh/git-hulk/git-hulk.github.io/images/lmstfy-consume.png" alt="img" class="img_ev3q"></p><p>消费时从 ready queue 中 (B)RPOP 出任务的 job id，然后根据 job id 从 pool 中将任务内容发送给消费者。同时对 tries 减一，根据消费的 ttr(time to run) 参数, 将任务放入 timer 中。如果 tries 为零, 在 ttr 时间到期后该 job id 会被放入 dead letter 队列中(表示任务执行失败)。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="同步任务模型">同步任务模型<a class="hash-link" href="#同步任务模型" title="Direct link to heading">​</a></h3><p>lmstfy 除了可以用来实现异步和延时任务模型之外，因为 namespace 下面的队列是动态创建且 job id 全局唯一，还可以用来实现同步任务模型 (producer 等到任务执行成功之后返回)。大概如下:</p><ol><li>producer 写入任务之后拿到 job id, 然后监听(consume)以 job id 为名的队列</li><li>consumer 消费任务成功后，写回复消息到同样以 job id 为名的队列中</li><li>producer 如果规定时间内能读到回复消息则认为消费成功，等待超时则认为任务失败</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何实现横向扩展">如何实现横向扩展<a class="hash-link" href="#如何实现横向扩展" title="Direct link to heading">​</a></h3><p>lmstfy 本身是无状态的服务可以很简单的实现横向扩展，这里的横向扩展主要是存储(目前只支持 Redis)的横向扩展。设计也比较简单，主要通过通过 namespace 对应的 token 路由来实现， 比如我们当前配置两组 Redis 资源: <code>default</code> 和 <code> meipai</code>:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Pool]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Pool.default]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Addr = &quot;1.1.1.1:6379&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Pool.meipai]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Addr = &quot;2.2.2.2:6389&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在创建 namespace 时可以指定资源池，token 里面会携带资源池名字作为前缀。比指定美拍资源池，那么 token 类似: <code>meipai:01DT8EZ1N6XT</code> ，后续在处理请求时就可以根据 token 里面携带的资源池名称来进行路由数据。不过这种设计实现队列级别的扩展，如果单队列存储消息量超过 Redis 内存上限则需要其他手段来解决(后面会支持磁盘类型存储)。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="如何使用">如何使用<a class="hash-link" href="#如何使用" title="Direct link to heading">​</a></h2><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token comment" style="color:rgb(98, 114, 164)"># 创建 namespace 和 token, 注意这里使用管理端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ ./scripts/token-cli -c -n test_ns -p default -D </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;test ns apply by @hulk&quot;</span><span class="token plain"> </span><span class="token number">127.0</span><span class="token plain">.0.1:7778</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;token&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;01DT9323JACNBQ9JESV80G0000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 写入内容为 value 的任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -XPUT -d </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;value&quot;</span><span class="token plain"> -i </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:7777/api/test_ns/q1?tries=3&amp;delay=1&amp;token=01DT931XGSPKNB7E2XFKPY3ZPB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;job_id&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;01DT9323JACNBQ9JESV80G0000&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;published&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 消费任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">$ </span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -i </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:7777/api/test_ns/q1?ttr=30&amp;timeout=3&amp;&amp;token=01DT931XGSPKNB7E2XFKPY3ZPB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;data&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;value&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;elapsed_ms&quot;</span><span class="token plain">:272612,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;job_id&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;01DT9323JACNBQ9JESV80G0000&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;msg&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;new job&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;namespace&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;test_ns&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;queue&quot;</span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">:</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;q1&quot;</span><span class="token plain">,</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;ttl&quot;</span><span class="token plain">:86127</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># ACK 任务 id，表示消费成功不再重新下发改任务</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">curl</span><span class="token plain"> -i -XDELETE </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http://127.0.0.1:7777/api/test_ns/q1/job/01DT9323JACNBQ9JESV80G0000?token=01DT931XGSPKNB7E2XFKPY3ZPB&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更详细 API 说明见项目 <a href="https://github.com/meitu/lmstfy/blob/master/README.md" target="_blank" rel="noopener noreferrer">README</a>，目前我们提供了 PHP/Golang 两种语言 SDK，其他语言可以直接基于 HTTP 库封装即可。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="监控指标">监控指标<a class="hash-link" href="#监控指标" title="Direct link to heading">​</a></h2><p>lmstfy 任务队列的另外一个设计目标是提供足够多的监控指标，除了作为监控报警之外，也可以为类似 k8s 的 scheduler 提供反馈指标，以当前队列堆积情况指导系统进行动态缩扩容。</p><p>业务指标:</p><ul><li>生产速度</li><li>消费速度</li><li>延迟数量</li><li>堆积数量 (queue size)</li><li>失败数量 (deadletter size)</li><li>任务从生产到被消费的时间分布 (P50, P95 etc.)</li></ul><p>性能相关指标:</p><ul><li>生产接口延迟 (P95)</li><li>消费接口延迟 (P95)</li><li>并发连接数</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="未来计划">未来计划<a class="hash-link" href="#未来计划" title="Direct link to heading">​</a></h2><p>在我们当前的使用场景下, 一个 2G 的 redis 实例就能够支撑千万级左右的延迟任务量。但类似对象存储的生命周期管理(对象存储的 TTL)这种量大且延时间长的场景，使用 Redis 存储成本比较高。后续会考虑基于本地文件或者以 kvrocks (自研的 SSD Redis KV) 作为存储，将数据落到磁盘。kvrocks 目前也是开源状态，美图内部线上已经部署接近 100 个实例，外部也有一些类似白山云等公司在使用，后面也会输出相关设计和实现文章。欢迎大家去关注和使用，更加欢迎 issue 和 PR。</p><p>kvrocks Github 项目地址: <a href="https://github.com/meitu/kvrocks" target="_blank" rel="noopener noreferrer">https://github.com/meitu/kvrocks</a></p><p>lmsty 的 Github 项目地址: <a href="https://github.com/meitu/lmstfy" target="_blank" rel="noopener noreferrer">https://github.com/meitu/lmstfy</a></p><p>如有更多技术问题想要交流可以发邮件给我: <a href="mailto:hulk.website@gmail.com" target="_blank" rel="noopener noreferrer">hulk.website@gmail.com</a></p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/lmstfy">LMSTFY</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/queue">Queue</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/redis">Redis</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/posts-tcpkit-improvement"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">tcpkit 一些改进</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/posts-redis-thread-io"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Redis 6 多线程 IO</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#使用场景" class="table-of-contents__link toc-highlight">使用场景</a></li><li><a href="#目标与调研" class="table-of-contents__link toc-highlight">目标与调研</a></li><li><a href="#设计和实现" class="table-of-contents__link toc-highlight">设计和实现</a><ul><li><a href="#基础概念" class="table-of-contents__link toc-highlight">基础概念</a></li><li><a href="#数据存储" class="table-of-contents__link toc-highlight">数据存储</a></li><li><a href="#任务写入" class="table-of-contents__link toc-highlight">任务写入</a></li><li><a href="#任务消费" class="table-of-contents__link toc-highlight">任务消费</a></li><li><a href="#同步任务模型" class="table-of-contents__link toc-highlight">同步任务模型</a></li><li><a href="#如何实现横向扩展" class="table-of-contents__link toc-highlight">如何实现横向扩展</a></li></ul></li><li><a href="#如何使用" class="table-of-contents__link toc-highlight">如何使用</a></li><li><a href="#监控指标" class="table-of-contents__link toc-highlight">监控指标</a></li><li><a href="#未来计划" class="table-of-contents__link toc-highlight">未来计划</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://weibo.com/u/2167039312" target="_blank" rel="noopener noreferrer" class="footer__link-item">Weibo<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/githulk" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/git-hulk" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Engineering Hulk, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.36814b66.js"></script>
<script src="/assets/js/main.e80ad31c.js"></script>
</body>
</html>